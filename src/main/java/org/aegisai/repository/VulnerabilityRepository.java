package org.aegisai.repository;

import org.aegisai.constant.SeverityStatus;
import org.aegisai.entity.Vulnerability;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface VulnerabilityRepository extends JpaRepository<Vulnerability, Integer> {

    // 특정 분석의 모든 취약점 조회
    List<Vulnerability> findByAnalysis_AnalysisId(Integer analysisId);

    // 특정 분석의 취약점을 심각도별로 조회 (Enum 사용)
    List<Vulnerability> findByAnalysis_AnalysisIdAndSeverity(Integer analysisId, SeverityStatus severity);

    // 특정 분석의 Critical 심각도 취약점 조회
    @Query("SELECT v FROM Vulnerability v WHERE v.analysis.analysisId = :analysisId AND v.severity = 'CRITICAL'")
    List<Vulnerability> findCriticalSeverityByAnalysisId(@Param("analysisId") Integer analysisId);

    // 특정 분석의 High 심각도 취약점 조회
    @Query("SELECT v FROM Vulnerability v WHERE v.analysis.analysisId = :analysisId AND v.severity = 'HIGH'")
    List<Vulnerability> findHighSeverityByAnalysisId(@Param("analysisId") Integer analysisId);

    // 특정 분석의 Medium 심각도 취약점 조회
    @Query("SELECT v FROM Vulnerability v WHERE v.analysis.analysisId = :analysisId AND v.severity = 'MEDIUM'")
    List<Vulnerability> findMediumSeverityByAnalysisId(@Param("analysisId") Integer analysisId);

    // 특정 분석의 Low 심각도 취약점 조회
    @Query("SELECT v FROM Vulnerability v WHERE v.analysis.analysisId = :analysisId AND v.severity = 'LOW'")
    List<Vulnerability> findLowSeverityByAnalysisId(@Param("analysisId") Integer analysisId);

    // 특정 분석의 취약점을 라인 번호순으로 조회
    List<Vulnerability> findByAnalysis_AnalysisIdOrderByLineNumber(Integer analysisId);

    // 특정 분석의 취약점을 심각도순으로 조회 (Critical > High > Medium > Low)
    @Query("SELECT v FROM Vulnerability v WHERE v.analysis.analysisId = :analysisId " +
           "ORDER BY CASE v.severity " +
           "WHEN 'CRITICAL' THEN 1 " +
           "WHEN 'HIGH' THEN 2 " +
           "WHEN 'MEDIUM' THEN 3 " +
           "WHEN 'LOW' THEN 4 " +
           "ELSE 5 END")
    List<Vulnerability> findByAnalysisIdOrderBySeverity(@Param("analysisId") Integer analysisId);

    // 특정 분석의 심각도별 개수 조회
    @Query("SELECT v.severity, COUNT(v) FROM Vulnerability v WHERE v.analysis.analysisId = :analysisId GROUP BY v.severity")
    List<Object[]> countBySeverityGroupByAnalysisId(@Param("analysisId") Integer analysisId);

    // 특정 분석의 취약점 개수
    long countByAnalysis_AnalysisId(Integer analysisId);

    // 특정 분석의 심각도별 취약점 개수 (Enum 사용)
    long countByAnalysis_AnalysisIdAndSeverity(Integer analysisId, SeverityStatus severity);

    // 특정 라인 번호의 취약점 조회
    List<Vulnerability> findByAnalysis_AnalysisIdAndLineNumber(Integer analysisId, Integer lineNumber);

    // 특정 메시지를 포함하는 취약점 검색
    @Query("SELECT v FROM Vulnerability v WHERE v.analysis.analysisId = :analysisId AND v.message LIKE %:keyword%")
    List<Vulnerability> searchByMessageKeyword(@Param("analysisId") Integer analysisId, @Param("keyword") String keyword);
}